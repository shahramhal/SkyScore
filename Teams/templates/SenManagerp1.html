{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEPARTMENT SUMMARY DASHBOARD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}" />
    <style>
        :root {
            --primary-color: #4a148c;
            --primary-light: #7c43bd;
            --primary-dark: #12005e;
            --accent-color: #4a148c;
            --text-dark: #333333;
            --text-light: #ffffff;
            --background-light: #f8f9fa;
            --card-bg: #ffffff;
            --primary-blue: #4a148c;
            --dark-blue: #12005e;
            --accent-blue: #7c43bd;
            --green: #4caf50;
            --red: #f44336;
            --orange: #ff9800;

            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-left: var(--sidebar-width, 250px);
        }
        
        .header-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: var(--text-light);
            padding: 25px 40px;
            text-align: center;
            position: relative;
        }
        
        .header-title {
            font-size: 2.2em;
            margin: 0;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .main-content {
            background-color: var(--background-light);
            padding: 30px 40px;
            margin-right: var(--sidebar-width, 250px);
        }
        
        .overview-tab {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 8px 25px;
            display: inline-block;
            font-weight: 600;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }
        
        .department-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .department-selector {
            flex-grow: 1;
            max-width: 350px;
        }
        
        .department-dropdown {
            width: 100%;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text-dark);
            box-shadow: var(--shadow);
            cursor: pointer;
        }
        
        .department-title {
            font-size: 1.8em;
            text-align: center;
            margin: 30px 0;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .summary-card-title {
            font-size: 1.1em;
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .summary-card-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .trend-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .trend-up {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--green);
        }
        
        .trend-down {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--red);
        }
        
        .trend-neutral {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--orange);
        }
        
        .charts-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            flex: 1 1 45%;
            min-width: 300px;
        }
        
        .chart-title {
            color: var(--primary-color);
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .team-summary-section {
            margin-top: 40px;
        }
        
        .team-summary-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .team-summary-table th,
        .team-summary-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .team-summary-table th {
            background-color: rgba(74, 20, 140, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .team-summary-table tr:last-child td {
            border-bottom: none;
        }
        
        .team-summary-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .score-cell {
            text-align: center;
            font-weight: 600;
        }
        
        .health-indicator {
            width: 15px;
            height: 15px;
            display: inline-block;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .health-good {
            background-color: var(--green);
        }
        
        .health-warning {
            background-color: var(--orange);
        }
        
        .health-critical {
            background-color: var(--red);
        }
        
        .vote-summary {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .vote-item {
            text-align: center;
            background-color: var(--card-bg);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 120px;
        }
        
        .vote-count {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 5px 0;
        }
        
        .vote-label {
            font-size: 0.9em;
            color: var(--text-dark);
        }
        
        .footer-banner {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            height: 10px;
        }
        
        .logo {
            position: absolute;
            right: 40px;
            top: 20px;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .sky {
            color: #ffffff;
        }
        
        .score {
            color: #e0e0e0;
        }
        
        .star-icon {
            color: #ffd700;
            margin-left: 3px;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .error-message {
            display: none;
            background-color: #fff3f3;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            color: #d32f2f;
            border-radius: var(--border-radius);
        }
        
        @media (max-width: 768px) {
            .charts-section {
                flex-direction: column;
            }
            
            .chart-container {
                flex: 1 1 100%;
            }
            
            .header-banner {
                padding: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .logo {
                position: relative;
                right: auto;
                top: auto;
                margin-top: 15px;
                display: block;
            }
            
            .vote-summary {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .vote-item {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    {% include "navbar.html" %}

    <div class="dashboard-container">
      <div class="header-banner">
          <h1 class="header-title">DEPARTMENT SUMMARY</h1>
          <div class="logo"><span class="sky">sky</span><span class="score">score</span></div>
      </div>
      
      <div class="main-content">
          <div class="overview-tab">DEPARTMENT OVERVIEW</div>
          
          <div class="department-controls">
              <div class="department-selector">
                  <select id="department-dropdown" class="department-dropdown" onchange="changeDepartment()">
                      {% for dept in departments %}
                          <option value="{{ dept.departmentid }}" {% if dept.departmentid == default_department.departmentid %}selected{% endif %}>
                              {{ dept.departmentname }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
          </div>
          
          <h2 id="current-department" class="department-title">
              {% if default_department %}
                  {{ default_department.departmentname }} Department
              {% else %}
                  No Departments Available
              {% endif %}
          </h2>
          
          <div id="loading-indicator" class="loading-indicator">
              Loading department data...
          </div>
          
          <div id="error-message" class="error-message">
              Unable to load department data. Please try again later.
          </div>
          
          <div class="vote-summary">
              <div class="vote-item">
                  <div class="vote-count" id="total-votes">--</div>
                  <div class="vote-label">Total Health Checks</div>
              </div>
              <div class="vote-item">
                  <div class="vote-count" id="participation-rate">--</div>
                  <div class="vote-label">Participation Rate</div>
              </div>
              <div class="vote-item">
                  <div class="vote-count" id="last-check-date">--</div>
                  <div class="vote-label">Last Health Check</div>
              </div>
          </div>
          
          <div class="summary-cards">
              <div class="summary-card">
                  <h3 class="summary-card-title">Overall Health Score</h3>
                  <div class="summary-card-value" id="health-score">--</div>
                  <div class="trend-badge trend-up" id="health-trend">--</div>
              </div>
              <div class="summary-card">
                  <h3 class="summary-card-title">Mission Score</h3>
                  <div class="summary-card-value" id="mission-score">--</div>
                  <div class="trend-badge trend-neutral" id="mission-trend">--</div>
              </div>
              <div class="summary-card">
                  <h3 class="summary-card-title">Speed Score</h3>
                  <div class="summary-card-value" id="speed-score">--</div>
                  <div class="trend-badge trend-up" id="speed-trend">--</div>
              </div>
              <div class="summary-card">
                  <h3 class="summary-card-title">Value Score</h3>
                  <div class="summary-card-value" id="value-score">--</div>
                  <div class="trend-badge trend-down" id="value-trend">--</div>
              </div>
          </div>
          
          <div class="charts-section">
              <div class="chart-container">
                  <h3 class="chart-title">Health Score Trend</h3>
                  <canvas id="trendChart"></canvas>
              </div>
              <div class="chart-container">
                  <h3 class="chart-title">Performance Metrics</h3>
                  <canvas id="radarChart"></canvas>
              </div>
          </div>
          
          <div class="team-summary-section">
              <h3 class="chart-title">Teams in Department</h3>
              <table class="team-summary-table">
                  <thead>
                      <tr>
                          <th>Team Name</th>
                          <th>Health</th>
                          <th>Mission</th>
                          <th>Speed</th>
                          <th>Value</th>
                          <th>Trend</th>
                      </tr>
                  </thead>
                  <tbody id="team-table-body">
                      <!-- Team data will be populated by JavaScript -->
                  </tbody>
              </table>
          </div>
      </div>
      
      <div class="footer-banner"></div>
  </div>

    <script>


        document.addEventListener('DOMContentLoaded', function() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Get the department ID from the dropdown
            const departmentDropdown = document.getElementById('department-dropdown');
            const deptId = departmentDropdown.value;
            
            // Load initial department data
            if (deptId) {
                fetchDepartmentData(deptId);
            } else {
                errorMessage.style.display = 'block';
                loadingIndicator.style.display = 'none';
            }
        });
        
        function changeDepartment() {
            const departmentDropdown = document.getElementById('department-dropdown');
            const currentDepartment = document.getElementById('current-department');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            
            // Get selected department
            const selectedDeptId = departmentDropdown.value;
            const selectedDeptName = departmentDropdown.options[departmentDropdown.selectedIndex].text;
            
            // Update title
            currentDepartment.textContent = selectedDeptName + " Department";
            
            // Hide error message if visible
            errorMessage.style.display = 'none';
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Fetch department data
            fetchDepartmentData(selectedDeptId);
        }
        
        function fetchDepartmentData(deptId) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            
            // Build URL with CSRF token for security
            const url = `/api/department-data/?dept=${deptId}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update dashboard with department data
                    updateDashboardData(data);
                    loadingIndicator.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching department data:', error);
                    errorMessage.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                });
        }
        
        function updateDashboardData(data) {
            // Update summary metrics
            if (data.summary) {
                document.getElementById('total-votes').textContent = data.summary.totalVotes;
                document.getElementById('participation-rate').textContent = data.summary.participationRate + '%';
                document.getElementById('last-check-date').textContent = data.summary.lastCheckDate;
            }
            
            // Calculate average scores from teams data
            let avgHealth = 0;
            let avgMission = 0;
            let avgSpeed = 0;
            let avgValue = 0;
            
            if (data.teams && data.teams.length > 0) {
                const totalTeams = data.teams.length;
                
                // Sum up scores from all teams
                data.teams.forEach(team => {
                    avgHealth += parseFloat(team.health) || 0;
                    avgMission += parseFloat(team.mission) || 0;
                    avgSpeed += parseFloat(team.speed) || 0;
                    avgValue += parseFloat(team.value) || 0;
                });
                
                // Calculate averages
                avgHealth = (avgHealth / totalTeams).toFixed(1);
                avgMission = (avgMission / totalTeams).toFixed(1);
                avgSpeed = (avgSpeed / totalTeams).toFixed(1);
                avgValue = (avgValue / totalTeams).toFixed(1);
                
                // Update score cards
                document.getElementById('health-score').textContent = avgHealth;
                document.getElementById('mission-score').textContent = avgMission;
                document.getElementById('speed-score').textContent = avgSpeed;
                document.getElementById('value-score').textContent = avgValue;
                
                // Update trend badges
                updateTrendBadge('health-trend', data.teams);
                updateTrendBadge('mission-trend', data.teams);
                updateTrendBadge('speed-trend', data.teams);
                updateTrendBadge('value-trend', data.teams);
                
                // Update team table
                updateTeamTable(data.teams);
            }
            
            // Update charts
            if (data.trends) {
                updateTrendChart(data.trends);
            }
            
            if (data.radar) {
                updateRadarChart(data.radar);
            }
        }
        
        function updateTrendBadge(elementId, teams) {
            const element = document.getElementById(elementId);
            let totalTrend = 0;
            
            // Calculate overall trend based on team trends
            teams.forEach(team => {
                totalTrend += parseFloat(team.trend) || 0;
            });
            
            const avgTrend = (totalTrend / teams.length).toFixed(1);
            
            // Update badge text
            if (avgTrend > 0) {
                element.textContent = `+${avgTrend}`;
                element.className = 'trend-badge trend-up';
            } else if (avgTrend < 0) {
                element.textContent = avgTrend;
                element.className = 'trend-badge trend-down';
            } else {
                element.textContent = '0.0';
                element.className = 'trend-badge trend-neutral';
            }
        }
        
        function updateTeamTable(teams) {
            const tableBody = document.getElementById('team-table-body');
            tableBody.innerHTML = '';
            
            teams.forEach(team => {
                const row = document.createElement('tr');
                
                // Team name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = team.name;
                row.appendChild(nameCell);
                
                // Health score cell
                const healthCell = document.createElement('td');
                healthCell.className = 'score-cell';
                
                // Add health indicator
                const healthIndicator = document.createElement('span');
                healthIndicator.className = 'health-indicator';
                if (team.health >= 7.5) {
                    healthIndicator.classList.add('health-good');
                } else if (team.health >= 5) {
                    healthIndicator.classList.add('health-warning');
                } else {
                    healthIndicator.classList.add('health-critical');
                }
                
                healthCell.appendChild(healthIndicator);
                healthCell.appendChild(document.createTextNode(team.health));
                row.appendChild(healthCell);
                
                // Mission score cell
                const missionCell = document.createElement('td');
                missionCell.className = 'score-cell';
                missionCell.textContent = team.mission;
                row.appendChild(missionCell);
                
                // Speed score cell
                const speedCell = document.createElement('td');
                speedCell.className = 'score-cell';
                speedCell.textContent = team.speed;
                row.appendChild(speedCell);
                
                // Value score cell
                const valueCell = document.createElement('td');
                valueCell.className = 'score-cell';
                valueCell.textContent = team.value;
                row.appendChild(valueCell);
                
                // Trend cell
                const trendCell = document.createElement('td');
                trendCell.className = 'score-cell';
                
                if (team.trend > 0) {
                    trendCell.textContent = `+${team.trend}`;
                    trendCell.style.color = 'var(--green)';
                } else if (team.trend < 0) {
                    trendCell.textContent = team.trend;
                    trendCell.style.color = 'var(--red)';
                } else {
                    trendCell.textContent = '0.0';
                    trendCell.style.color = 'var(--orange)';
                }
                
                row.appendChild(trendCell);
                
                // Add row to table
                tableBody.appendChild(row);
            });
        }
        
        function updateTrendChart(trendData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.months,
                    datasets: [{
                        label: 'Health Score',
                        data: trendData.healthScores,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(74, 20, 140, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'var(--primary-color)',
                        pointRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function updateRadarChart(radarData) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            // Check if chart already exists and destroy it
            if (window.radarChart) {
                window.radarChart.destroy();
            }
            
            window.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarData.categories,
                    datasets: [{
                        label: 'Score',
                        data: radarData.scores,
                        backgroundColor: 'rgba(74, 20, 140, 0.2)',
                        borderColor: 'var(--primary-color)',
                        pointBackgroundColor: 'var(--primary-color)',
                        pointRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 2,
                                display: false
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>